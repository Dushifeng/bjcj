<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>分析数据</title>

    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>
<div class="container" style="margin-top: 50px">
    <div class="row" >
        <div class="form-group  col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <textarea class="form-control" rows="15" id="content"></textarea>
        </div>
    </div>
    <button class="btn btn-info" id="analysisBtn">分析数据</button>
    <button class="btn btn-info" id="MaxBtn">最大值</button>
    <button class="btn btn-info" id="noMaxBtn">去最大值</button>
    <div class="row" style="margin-top: 20px">
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" id="CPU" style="height: 500px">
        </div>
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" id="Memory" style="height: 500px">

        </div>
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12"  id="LoadTime" style="height: 500px">

        </div>
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-xs-12" id="NetCardTraffic" style="height: 500px">

        </div>

    </div>
</div>
</body>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/echarts/4.2.1-rc1/echarts.min.js"></script>
<script type="text/javascript">
    var jsoncontent;
    // 工具方法
    var formatJson = function(json, options) {
        var reg = null,
            formatted = '',
            pad = 0,
            PADDING = '    '; // one can also use '\t' or a different number of spaces
        // optional settings
        options = options || {};
        // remove newline where '{' or '[' follows ':'
        options.newlineAfterColonIfBeforeBraceOrBracket = (options.newlineAfterColonIfBeforeBraceOrBracket === true) ? true : false;
        // use a space after a colon
        options.spaceAfterColon = (options.spaceAfterColon === false) ? false : true;

        // begin formatting...

        // make sure we start with the JSON as a string
        if (typeof json !== 'string') {
            json = JSON.stringify(json);
        }
        // parse and stringify in order to remove extra whitespace
        json = JSON.parse(json);
        json = JSON.stringify(json);

        // add newline before and after curly braces
        reg = /([\{\}])/g;
        json = json.replace(reg, '\r\n$1\r\n');

        // add newline before and after square brackets
        reg = /([\[\]])/g;
        json = json.replace(reg, '\r\n$1\r\n');

        // add newline after comma
        reg = /(\,)/g;
        json = json.replace(reg, '$1\r\n');

        // remove multiple newlines
        reg = /(\r\n\r\n)/g;
        json = json.replace(reg, '\r\n');

        // remove newlines before commas
        reg = /\r\n\,/g;
        json = json.replace(reg, ',');

        // optional formatting...
        if (!options.newlineAfterColonIfBeforeBraceOrBracket) {
            reg = /\:\r\n\{/g;
            json = json.replace(reg, ':{');
            reg = /\:\r\n\[/g;
            json = json.replace(reg, ':[');
        }
        if (options.spaceAfterColon) {
            reg = /\:/g;
            json = json.replace(reg, ': ');
        }

        $.each(json.split('\r\n'), function(index, node) {
            var i = 0,
                indent = 0,
                padding = '';

            if (node.match(/\{$/) || node.match(/\[$/)) {
                indent = 1;
            } else if (node.match(/\}/) || node.match(/\]/)) {
                if (pad !== 0) {
                    pad -= 1;
                }
            } else {
                indent = 0;
            }

            for (i = 0; i < pad; i++) {
                padding += PADDING;
            }
            formatted += padding + node + '\r\n';
            pad += indent;
        });
        return formatted;
    };
    // $(document).on('input propertychange', '#content', function() {
    //     //function code....
    //     jsoncontent = $("#content").val()
    //     var content = $("#content").val()
    //     var nc = formatJson(content)
    //     $("#content").val(nc)
    // });

    // 基于准备好的dom，初始化echarts实例
    var cpuChart = echarts.init(document.getElementById('CPU'));
    var memoryChart = echarts.init(document.getElementById('Memory'));
    var loadTimeChart = echarts.init(document.getElementById('LoadTime'));
    var netCardTrafficChart = echarts.init(document.getElementById('NetCardTraffic'));

    // 使用刚指定的配置项和数据显示图表。
    cpuChart.setOption({
        tooltip: {},
        legend: {
            data:['CPU'],
            formatter:  function(name){

                return name+"（unit：%）"
            },
        },
        xAxis: {
            data: []
        },
        yAxis: {
        },
        series: [{
            name: 'CPU',
            type: 'bar',
            color:["#0066FF"],
            data: [],
            barWidth : 35,
            itemStyle: {
                normal: {
                    label: {
                        show: true, //开启显示
                        position: 'top', //在上方显示
                        textStyle: { //数值样式
                            color: 'black',
                            fontSize: 16
                        },formatter: function(data) {

                            return parseFloat(data.value).toFixed(2)

                        }
                    }
                }
            },
        }]
    });
    memoryChart.setOption({

        tooltip: {},
        legend: {
            data:['RAM'],
            formatter:  function(name){

                return name+"（unit：Mb）"
            },
        },
        xAxis: {
            data: []
        },
        yAxis: {
        },
        series: [{
            name: 'RAM',
            type: 'bar',
            color:["#CC66CC"],
            data: [],
            barWidth : 35,
            itemStyle: {
                normal: {
                    label: {
                        show: true, //开启显示
                        position: 'top', //在上方显示
                        textStyle: { //数值样式
                            color: 'black',
                            fontSize: 16
                        },formatter: function(data) {

                            return parseFloat(data.value).toFixed(2)

                        }
                    }
                }
            },
        }]
    });
    loadTimeChart.setOption({

        tooltip: {},
        legend: {
            data:['Load time'],
            formatter:  function(name){

                return name+"（unit：s）"
            },
        },
        xAxis: {
            data: []
        },
        yAxis: {

        },
        series: [{
            name: 'Load time',
            type: 'bar',
            color:["#FF3300"],
            data: [],
            barWidth : 35,
            itemStyle: {
                normal: {
                    label: {
                        show: true, //开启显示
                        position: 'top', //在上方显示
                        textStyle: { //数值样式
                            color: 'black',
                            fontSize: 16
                        },formatter: function(data) {

                            return parseFloat(data.value).toFixed(2)

                        }
                    }
                }
            },
        }]
    });
    netCardTrafficChart.setOption({

        tooltip: {},

        xAxis: {
            data: []
        },
        yAxis: {

        },
        series: [{
            name: 'kb',
            type: 'bar',
            color:["#FF9900"],
            data: [],
            itemStyle: {
                normal: {
                    label: {
                        show: true, //开启显示
                        position: 'top', //在上方显示
                        textStyle: { //数值样式
                            color: 'black',
                            fontSize: 16
                        }
                    }
                }
            },

        }]
    });
    var labelOption = {
        normal: {
            show: true,
            position: 15,
            align: 'left',
            verticalAlign: 'middle',
            rotate: 90,
            formatter: '{c}  {name|{a}}',
            fontSize: 16,
            rich: {
                name: {
                    textBorderColor: '#fff'
                }
            }
        }
    };

    $("#MaxBtn").click(function () {
        cpuChart.setOption({
            yAxis: {
                type:'value',
                scale:true,
                max:50,
                min:0,
                splitNumber:5
            }
        })

        memoryChart.setOption({
            yAxis: {
                type:'value',
                scale:true,
                max:210,
                min:0,
                splitNumber:7
            }
        })

        loadTimeChart.setOption({
            yAxis: {
                type:'value',
                scale:true,
                max:3.5,
                min:0,
                splitNumber:7
            }
        })

        netCardTrafficChart.setOption({
            yAxis: {
                type:'value',
                scale:true,
                max:1000,
                min:0,
                splitNumber:10
            }
        })
    })

    $("#noMaxBtn").click(function () {
        cpuChart.setOption({
            yAxis: {
            }
        })

        memoryChart.setOption({
            yAxis: {
            }
        })

        loadTimeChart.setOption({
            yAxis: {}
        })

        netCardTrafficChart.setOption({
            yAxis: {}
        })
    })
    $("#analysisBtn").click(function () {
        var content = $("#content").val()
        try {
            var cj = JSON.parse(content)
            var cpuM = [];
            var memoryM = [];
            var loadTimeM = [];

            var pagename = [];
            var txM = []
            var rxM = []
            $.each(cj.pages,function(n,value) {
                var name = value.page
                var cpu = 0.0
                var memory = 0.0
                pagename.push(name)
                $.each(value.cpu,function (n,v) {
                    cpu+=v
                })
                cpu = cpu/value.cpu.length
                cpuM.push(cpu)

                $.each(value.memory,function (n,v) {
                    memory+=v
                })
                memory = memory/value.memory.length
                memoryM.push(memory)

                var net = JSON.parse(value.netCardTraffic)
                txM.push(net.tx)
                rxM.push(net.rx)
                loadTimeM.push(value.loadTime)
            })


            console.log(memoryM)
            cpuChart.setOption({
                xAxis: {
                    data: pagename
                },
                series: [{
                    data: cpuM
                }]
            })

            memoryChart.setOption({
                xAxis: {
                    data: pagename
                },
                series: [{
                    data: memoryM
                }]
            })

            loadTimeChart.setOption({
                xAxis: {
                    data: pagename
                },
                series: [{
                    data: loadTimeM
                }]
            })

            netCardTrafficChart.setOption({
                color: ['#003366', '#33FF66'],
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['out data', 'in data'],
                    formatter:  function(name){

                        return name+"（unit：kb）"
                    },
                },
                xAxis: [
                    {
                        type: 'category',
                        axisTick: {show: false},
                        data: pagename
                    }
                ],
                yAxis: [
                    {
                        type: 'value'
                    }
                ],
                series: [
                    {
                        name: 'out data',
                        type: 'bar',

                        data: txM,
                        itemStyle: {
                            normal: {
                                label: {
                                    show: true, //开启显示
                                    position: 'top', //在上方显示
                                    textStyle: { //数值样式
                                        color: 'black',
                                        fontSize: 16
                                    },formatter: function(data) {

                                        return parseFloat(data.value).toFixed(2)

                                    }
                                }
                            }
                        },

                    },{
                        name: 'in data',
                        type: 'bar',

                        data: rxM,
                        itemStyle: {
                            normal: {
                                label: {
                                    show: true, //开启显示
                                    position: 'top', //在上方显示
                                    textStyle: { //数值样式
                                        color: 'black',
                                        fontSize: 16
                                    },formatter: function(data) {

                                        return parseFloat(data.value).toFixed(2)

                                    }
                                }
                            }
                        },

                    }
                ]
            })

        }catch (e) {
            alert("输入的json字符串错误，请检查后重试。。。")
            console.log(e)
        }

        return false;
    })
</script>
</html>